mode: Rule
log-level: info

geox-url:
  geoip: https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat
  geosite: https://cdn.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat

hosts:
  'dns.alidns.com': [223.5.5.5, 223.6.6.6, '2400:3200::1', '2400:3200:baba::1']
  'doh.pub': [1.12.12.12, 120.53.53.53, '2402:4e00::']
  'dns.google': [8.8.8.8, 8.8.4.4, '2001:4860:4860::8888', '2001:4860:4860::8844']
  'cloudflare-dns.com': [1.1.1.1, 1.0.0.1, '2606:4700:4700::1111', '2606:4700:4700::1001']


dns:
  enable: true
  listen: :1053
  ipv6: true
  
  # 模式调整为 fake-ip，速度更快
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter-mode: blacklist
  
  # 必须开启，确保 DNS 遵循规则
  respect-rules: true
  prefer-h3: true
  fast-query: true
  
  # 默认 DNS (兜底)
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  
  # 常规 DNS 池
  nameserver:
    - https://dns.alidns.com/dns-query
    - https://doh.pub/dns-query
  
  # 代理 DNS 池
  proxy-server-nameserver:
    - https://dns.google/dns-query
    - https://1.1.1.1/dns-query

  # === 你的核心策略 (完整保留) ===
  nameserver-policy:
    # 1. 特定电信业务域名，指定走特定 IP 解析
    "+.ctc.com,+.gdtel.com,+.chinatelecom.cn":
      - 132.121.218.164
      
    # 2. 广告规则集，直接返回成功状态码 (屏蔽)
    "rule-set:category-ads-all": rcode://success
    
    # 3. 国内/直连规则集 -> 走国内 DNS
    "rule-set:cn,local,google_cn,microsoft_cn,microsoft_domain,xiaomi_domain":
      - https://dns.alidns.com/dns-query
      - https://doh.pub/dns-query
      
    # 4. 国外/被墙/AI/F1规则集 -> 走国外 DNS
    "rule-set:gfw,google_domain,ai,github_domain,f1,docker_domain":
      - https://dns.google/dns-query
      - https://1.1.1.1/dns-query

  # Fake-IP 过滤 (保留了你的原条目，并补充了防断连的条目)
  fake-ip-filter:
    - '+.lan'
    - '+.local'
    - 'rule-set:local'
    - 'rule-set:ai'
    - 'rule-set:cn'
    - 'rule-set:apple_domain'
    - 'rule-set:google_cn'
    - 'rule-set:xiaomi_domain'
    # Windows 连通性探测 (防止显示无网络)
    - '+.msftncsi.com'
    - 'msftconnecttest.com'
    # 补充：STUN/NTP 等需要真实 IP 的服务
    - "+.stun.*.*"
    - "+.stun.*"
    - "+.ntp.org"

sniffer:
  enable: true
  # 开启这两项可增强域名还原能力
  force-dns-mapping: true
  parse-pure-ip: true
  # 关键：覆盖目标地址
  override-destination: true
  
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
      
  # 这里的列表保留你原本的配置
  skip-domain:
    - "geosite:cn"
    - "+.apple.com"
    - "+.baidu.com"
    - "imap.189.cn"
    - "Mijia Cloud"
  skip-dst-address:
    - "geoip:cn"

# 规则集定义 (统一使用 4422 加速前缀)
rule-providers:
  # Class 类型
  f1:
    <<: *class
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/HH3456/own/main/metasub/rule_f1.list"
  lan:
    <<: *class
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/HH3456/own/main/metasub/rule_lan.list"
  dns:
    <<: *class
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/HH3456/own/main/metasub/rule_dns.list"
  local:
    <<: *class
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/HH3456/own/main/metasub/rule_local.list"
  rule_reject:
    <<: *class
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/HH3456/own/main/metasub/rule_reject.list"
  
  # Domain 类型 (MetaCubeX 源)
  private_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.mrs"
  ai:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/category-ai-!cn.mrs"
  gfw:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/gfw.mrs"
  spotify_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/spotify.mrs"
  google_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.mrs"
  google_cn:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google@cn.mrs"
  github_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/github.mrs"
  python_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/python.mrs"
  apple_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/apple.mrs"
  microsoft_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft.mrs"
  microsoft_cn:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft@cn.mrs"
  cn:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.mrs"
  category-ads-all:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/category-ads-all.mrs"
  xiaomi_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/xiaomi.mrs"
  docker_domain:
    <<: *domain
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/docker.mrs"

  # IP 类型
  cn_ip:
    <<: *ip
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.mrs"
  telegram_ip:
    <<: *ip
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.mrs"
  apple_ip:
    <<: *ip
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo-lite/geoip/apple.mrs"
  google_ip:
    <<: *ip
    url: "http://subcon.44224422.xyz:5547/https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.mrs"
